<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="pixel-er">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
      }
    </style>
    <canvas id="canvas" width="400" height="400"></canvas>
    <img id="image" on-load="_onImageLoaded">
  </template>

  <script>
    var canvasWidth = 400;

    Polymer({
      is: 'pixel-er',

      properties: {
        file: {
          type: Object,
          observer: '_fileChanged'
        },

        resolution: {
          type: Number,
          value: 50
        }
      },

      attached: function() {
        this._ctx = this.$.canvas.getContext('2d');
        this.$.canvas.width = canvasWidth;
      },

      _fileChanged: function(file) {
        if (!this._reader) {
          this._reader = new FileReader();
          this._reader.onload = this._loadFile.bind(this);
        }
        this._reader.readAsDataURL(file);
      },

      _loadFile: function(event) {
        this.$.image.src = event.target.result;
        //filename.innerHTML = e.target.files[0].name;
      },

      _onImageLoaded: function(event) {
        var imageRatio = this.$.image.height / this.$.image.width;

        var pixelsPerWidth = this.resolution;
        var pixelsPerHeight = Math.floor(pixelsPerWidth * imageRatio);

        // Adjust the canvas to fit the shape of the image.
        this.$.canvas.height = Math.ceil(canvasWidth * imageRatio);

        this._displayPixelatedImage(pixelsPerWidth, pixelsPerHeight);
      },

      _displayPixelatedImage: function(pixelsPerWidth, pixelsPerHeight) {
        // Oopsies?
        if (!this.$.canvas.width || !this.$.canvas.height) {
          return;
        }

        // Draw the image super tiny and then scale it from the tiny size
        // to the actual canvas size, which pixellates it.
        this._ctx.drawImage(this.$.image, 0, 0, pixelsPerWidth, pixelsPerHeight);
        this._ctx.drawImage(this.$.canvas,
                     0, 0, pixelsPerWidth, pixelsPerHeight,          /* source */
                     0, 0, this.$.canvas.width, this.$.canvas.height /* dest */);

        var imageData = this._ctx.getImageData(0, 0, this.$.canvas.width, this.$.canvas.height);
      }

    });
  </script>
</dom-module>
